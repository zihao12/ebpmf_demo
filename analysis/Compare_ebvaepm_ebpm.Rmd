---
title: "Compare_ebvaepm_ebpm"
author: "zihao12"
date: "2019-10-23"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---
Here I show and compare the results from `ebvae_pm` and `ebpm_exponential_mixture`, `ebpm_point_gamma`. `ebvae_pm` was implemented and experimented here: https://zihao12.github.io/ebpmf_demo/ebvae-poisson-normal.html . 

After training  for 10000 iterations, `ebvae_pm` beats `ebpm_exponential_mixture`, `ebpm_point_gamma`. This is of course not fair as data is generated from the assumption of the `ebvae_pm` model. But at least this result shows we can use VAE to do Empirical Bayes.

```{r warning=F}
devtools::load_all("../ebpm")
library(ggplot2)
library(reticulate)
```

## show VAE results
```{r}
vae_out = py_load_object("data/poisson-normal.pkl", pickle = "pickle")
vae_out = data.frame(vae_out)

## This is what data looks like
ggplot(vae_out)+
  geom_histogram(aes(x = x), bins = 100)

ggplot(vae_out)+
  geom_point(aes(x = x, y = posterior_vae))
```

## Compare with `ebpm_exponential_mixture`
```{r warning=F}
library(ebpm)
fit_ebpm_exp = ebpm_exponential_mixture(as.vector(vae_out$x), s = 1, m = 2^0.25)
vae_out[["posterior_ebpm_exp"]] = fit_ebpm_exp$posterior$mean
ggplot(vae_out)+
  geom_point(aes(x = x, y = posterior_ebpm_exp))
```


```{r}
## biggest weight
max(fit_ebpm_exp$fitted_g$pi)
## the mean  of the exponential component corresponding to the biggest weight
fit_ebpm_exp$fitted_g$scale[which.max(fit_ebpm_exp$fitted_g$pi)]
```


## Compare with `ebpm_exponential_mixture`
```{r warning=F}
library(ebpm)
fit_ebpm_point = ebpm_point_gamma(as.vector(vae_out$x), s = 1)
vae_out[["posterior_ebpm_point"]] = fit_ebpm_point$posterior$mean
ggplot(vae_out)+
  geom_point(aes(x = x, y = posterior_ebpm_point))
```


```{r}
## fitted_g from point_gamma
class(fit_ebpm_point$fitted_g) = "data.frame"
fit_ebpm_point$fitted_g
```


## Compare RMSE
```{r}
## rmse(fit_vae, lam)
sqrt(mean((vae_out$posterior_vae - vae_out$lam)^2))

## rmse(fit_ebpm_exp, lam)
sqrt(mean((fit_ebpm_exp$posterior$mean - vae_out$lam)^2))

## rmse(fit_ebpm_point, lam)
sqrt(mean((fit_ebpm_point$posterior$mean - vae_out$lam)^2))


## rmse(mle, lam)
sqrt(mean((vae_out$x- vae_out$lam)^2))
```






